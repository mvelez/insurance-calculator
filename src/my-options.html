<!doctype html>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">

<script>
/* global Highcharts numeral:true */
</script>
<link rel="import" href="../bower_components/numeral-js/numeral-js.html">

<dom-module id="my-options">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
    </style>
    <style include="iron-flex iron-flex-alignment">
      .container {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
      }
    </style>

    <div class="card">
      <h1>Insurance Options</h1>
      <p>Based on your answers these are your options.  Note that if your spouse
        works and their employer offers insurance but they decline their
        employer sponsored insurance, there may be an additional fee.  This site
        does not account for that additional charge yet.
      </p>

      <vaadin-grid id="optionGrid">
        <table>
          <colgroup>
            <col name="planName" sortable>
            <col name="coverageLevel" sortable>
            <col name="premium" sortable>
            <col name="deductible" sortable>
            <col name="savingsAccountContribution" sortable>
            <col name="savingsAccountType" sortable>
            <col name="incomeBracket" sortable>
          </colgroup>
        </table>
      </vaadin-grid>
      <div class="container">
        <a href="/questions"><paper-button raised>Back</paper-button></a>
        <a href="/scenarios"><paper-button raised>Next</paper-button></a>
      </div>
    </div>

    <iron-ajax
      auto
      url="/data/coverage-levels.json"
      method="get"
      handle-as="json"
      last-response="{{coverageLevels}}">
    </iron-ajax>
    <iron-ajax
      auto
      url="/data/rates-2017.json"
      method="get"
      handle-as="json"
      last-response="{{rateSheet}}">
    </iron-ajax>
    <iron-ajax
      auto
      url="/data/addons-2017.json"
      method="get"
      handle-as="json"
      last-response="{{addonsSheet}}">
    </iron-ajax>
    <iron-ajax
      auto
      url="/data/plans.json"
      method="get"
      handle-as="json"
      last-response="{{planSheet}}">
    </iron-ajax>
  </template>

  <script>
    var currencyRenderer = function (cell) {
      cell.element.innerHTML = numeral(cell.data).format('$0,0');
    };

    function generateCustomOption(plan, coverageLevel) {
      var option = {};
      option.planName = plan.name;
      option.deductible = plan.deductible;
      option.savingsAccountContribution = plan.savingsAccountContribution;
      option.coverageLevel = coverageLevel;
      option.incomeBracket = 'n/a';
      option.coinsuranceRate = plan.coinsuranceRate;
      option.savingsAccountType = plan.savingsAccountType;
      option.savingsAccountContribution = plan.savingsAccountContribution;
      option.premium = plan.premium;
      option.coinsuranceMax = plan.coinsuranceMax;
      return option;
    }

    function generateOption(plan, coverageLevel, incomeBracket, addons) {
      var option = {};
      var i = 0;
      option.planName = plan.name;
      option.deductible = plan.deductible;
      option.savingsAccountContribution = plan.savingsAccountContribution;
      option.coverageLevel = coverageLevel;
      option.incomeBracket = incomeBracket;
      option.coinsuranceRate = plan.coinsuranceRate;
      option.savingsAccountType = plan.savingsAccountType;
      option.savingsAccountContribution = plan.savingsAccountContribution;
      for (i = 0; i < plan.incomeBrackets.length; i += 1) {
        if (plan.incomeBrackets[i].incomeBracket === incomeBracket) {
          option.premium = plan.incomeBrackets[i].premium + addons;
          option.coinsuranceMax = plan.incomeBrackets[i].coinsuranceMax;
          return option;
        }
      }
      return null;
    }

    function lookupCoverageLevel(target, lookupValues) {
      var i = 0;
      for (i = 0; i < lookupValues.length; i += 1) {
        if (target === lookupValues[i].coverageLevel) {
          return lookupValues[i].description;
        }
      }
      return null;
    }

    function lookupStateSurcharge(state, coverageLevel, lookupValues) {
      var i = 0;
      for (i = 0; i < lookupValues.length; i += 1) {
        if (state === lookupValues[i].state) {
          return lookupValues[i][coverageLevel];
        }
      }
      return null;
    }

    function lookupPlanDescription(target, lookupValues) {
      var i = 0;
      for (i = 0; i < lookupValues.length; i += 1) {
        if (target === lookupValues[i].name) {
          return lookupValues[i];
        }
      }
      return null;
    }

    Polymer({
      is: 'my-options',
      properties: {
        filterOptions: {
          type: Object,
          notify: true,
        },
        coverageLevels: {
          type: Object,
          notify: true,
        },
        rateSheet: {
          type: Object,
          notify: true,
        },
        addonsSheet: {
          type: Object,
          notify: true,
        },
        planSheet: {
          type: Object,
          notify: true,
        },
        customPlans: {
          type: Array,
          notify: true,
        },
        unrankedOptions: {
          type: Array,
          notify: true,
          computed: 'denormalizeOptions(rateSheet, coverageLevels, addonsSheet, planSheet, filterOptions.*, customPlans)',
        },
      },
      observers: [
        'updateGrid(unrankedOptions)',
      ],

      denormalizeOptions: function (rateSheet, coverageLevels, addonsSheet,
        planSheet, filterOptions, customPlans) {
        var coverageLevel;
        var customCoverageLevel;
        var i = 0;
        var j = 0;
        var k = 0;
        var plan;
        var planDescription;
        var unrankedOptions = [];
        var addons = 0;

        if (filterOptions.value.useTobacco) {
          addons += addonsSheet.tobaccoSurcharge;
        }

        for (i = 0; i < rateSheet.coverageLevels.length; i += 1) {
          for (j = 0; j < filterOptions.value.suitablePlans.length; j += 1) {
            // eliminate coverageLevels that don't need to be considered
            if (rateSheet.coverageLevels[i].coverageLevel === filterOptions.value.suitablePlans[j].coverageLevel) {
              coverageLevel = lookupCoverageLevel(
                rateSheet.coverageLevels[i].coverageLevel,
                coverageLevels.coverageLevels);
              for (k = 0; k < rateSheet.coverageLevels[i].plans.length; k += 1) {

                addons += lookupStateSurcharge(filterOptions.value.surchargeState,
                  rateSheet.coverageLevels[i].coverageLevel,
                  addonsSheet.stateSurcharge);

                // handle if there is a spouse and there are custom plans being considered
                if (filterOptions.value.spouseAddon && !filterOptions.value.suitablePlans[j].custom) {
                  addons += filterOptions.value.spouseAddon;
                } else if (filterOptions.value.spouseAddon && filterOptions.value.suitablePlans[j].custom) {
                  customCoverageLevel = lookupCoverageLevel(
                        filterOptions.value.suitablePlans[j].custom.coverageLevel,
                        coverageLevels.coverageLevels);
                  unrankedOptions.push(
                  generateCustomOption(filterOptions.value.suitablePlans[j].custom,
                    customCoverageLevel));
                }

                plan = rateSheet.coverageLevels[i].plans[k];
                planDescription = lookupPlanDescription(plan.name, planSheet.plans);
                plan.coinsuranceRate = planDescription.coinsuranceRate;
                plan.savingsAccountType = planDescription.hraOrHsa;
                unrankedOptions.push(
                  generateOption(plan,
                    coverageLevel,
                    filterOptions.value.incomeBracket,
                    addons));
              }
            }
          }
        }

        return unrankedOptions;
      },
      updateGrid: function (unrankedOptions) {
        var grid = this.$.optionGrid;
        grid.columns[2].renderer = currencyRenderer;
        grid.columns[3].renderer = currencyRenderer;
        grid.columns[4].renderer = currencyRenderer;
        grid.items = unrankedOptions;
      },
    });
  </script>
</dom-module>
