<!doctype html>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">

<script>
/* global Highcharts numeral:true */
</script>
<link rel="import" href="../bower_components/highcharts-chart/highcharts-chart.html">
<link rel="import" href="../bower_components/numeral-js/numeral-js.html">


<dom-module id="my-scenarios">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
    </style>

    <style include="iron-flex iron-flex-alignment">
      paper-card {
        width: 100%;
      }
    </style>

    <div class="card">
      <h1>Cost Estimator</h1>
      <p>
        Explore how this will help you cover potential health scenarios.
        Use the slider below to choose your expected healthcare costs.
        Initial value is based on CDC statistics for an adult age 18 to 44.
      </p>

      <vaadin-grid id="cdcCostGrid">
        <table>
          <colgroup>
            <col>
            <col>
            <col>
          </colgroup>
          <thead>
            <tr>
              <th>Age Range (years)</th>
              <th>% with Expenses</th>
              <th>Average (Mean) Expense of Those With Expenses</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>0 - 6</td>
              <td>88.8%</td>
              <td>$2,154</td>
            </tr>
            <tr>
              <td>6 - 17</td>
              <td>85.7%</td>
              <td>$2,064</td>
            </tr>
            <tr>
              <td>18 - 44</td>
              <td>75.5%</td>
              <td>$3,512</td>
            </tr>
            <tr>
              <td>45 - 64</td>
              <td>88.9%</td>
              <td>$6,799</td>
            </tr>
            <tr>
              ...
            </tr>
          </tbody>
        </table>
        <p>
          <a href="https://www.cdc.gov/nchs/data/hus/hus15.pdf#097">Source</a>
        </p>
      </vaadin-grid>
      <div>Total Healthcare Costs:
         <span class="caption">{{totalHealthcareCostsLabel}}</span>
      </div>
      <paper-slider value="{{logTotalHealthcareCosts}}" max="11.512925465" step=".001"></paper-slider>
      <template id="scenarioCharts" is="dom-repeat" items="{{chartOptions}}" as="chartOption">
        <highcharts-chart highchart-options="{{chartOption}}" />
      </template>
      <div class="horizontal start-justified layout">
        <a href="/options"><paper-button raised>Back</paper-button></a>
      </div>
    </div>
  </template>

  <script>

  function arrayForProperty(objectArray, property) {
    var returnValue = [];
    var i = 0;
    for (i = 0; i < objectArray.length; i += 1) {
      returnValue.push(objectArray[i][property]);
    }
    return returnValue;
  }

  function sumForProperty(objectArray, property) {
    var returnValue = 0;
    var i = 0;
    for (i = 0; i < objectArray.length; i += 1) {
      returnValue += objectArray[i][property];
    }
    return Math.round(returnValue);
  }

  function minimumValue(a, b) {
    if (a < b) {
      return a;
    }
    return b;
  }

  function calculateTotalHealthcareSpending(scenario) {
    var total = scenario.insuranceOption.employeePlan.premium;
    total += sumForProperty(scenario.performance, 'paidFromDeductible');
    total += sumForProperty(scenario.performance, 'paidFromCoinsurance');

    return 'Total Healthcare Spending: ' + numeral(total).format('$0,0');
  }

  function allocateCosts(cost, deductibleBalance, savingsBalance,
    coinsuranceBalance, coinsuranceRate) {
    var paymentShare = {};
    var toAllocate = cost;
    var appliedAmount = 0;
    var deductibleRemaining = deductibleBalance;
    var savingsContributionRemaining = savingsBalance;
    var coinsuranceRemaining = coinsuranceBalance;
    paymentShare.healthcareCost = toAllocate;
    paymentShare.paidFromSavingsContribution = 0;
    paymentShare.paidFromDeductible = 0;
    paymentShare.paidFromCoinsurance = 0;
    paymentShare.insuredByCoinsurance = 0;
    paymentShare.insuredTotally = 0;

    if (toAllocate > 0 && deductibleRemaining > 0 && savingsContributionRemaining > 0) {
      appliedAmount = minimumValue(savingsContributionRemaining, toAllocate);
      paymentShare.paidFromSavingsContribution = Math.round(appliedAmount * 100) / 100;
      deductibleRemaining -= appliedAmount;
      toAllocate -= appliedAmount;
    }

    if (toAllocate > 0 && deductibleRemaining > 0) {
      appliedAmount = minimumValue(deductibleRemaining, toAllocate);
      paymentShare.paidFromDeductible = Math.round(appliedAmount * 100) / 100;
      toAllocate -= appliedAmount;
    }

    if (toAllocate > 0 && coinsuranceRemaining > 0) {
      appliedAmount = minimumValue(
        (coinsuranceRemaining * (1 / coinsuranceRate)), toAllocate);
      paymentShare.paidFromCoinsurance = Math.round(
        (appliedAmount * coinsuranceRate) * 100) / 100;
      paymentShare.insuredByCoinsurance = Math.round(
        (appliedAmount * (1 - coinsuranceRate) * 100)) / 100;
      toAllocate -= appliedAmount;
    }

    if (toAllocate > 0) {
      paymentShare.insuredTotally = Math.round(toAllocate * 100) / 100;
    }
    return paymentShare;
  }

  function calculatePerformance(insuranceOption, healthcareCosts) {
    var paymentShares = [];
    var paymentShare = {};
    var i = 0;
    var savingsContributionRemaining = insuranceOption.employeePlan.savingsAccountContribution;
    var deductibleRemaining = insuranceOption.employeePlan.deductible;
    var coinsuranceRemaining = insuranceOption.employeePlan.coinsuranceMax;

    for (i = 0; i < healthcareCosts.length; i += 1) {
      paymentShare = allocateCosts(healthcareCosts[i].employee, deductibleRemaining,
        savingsContributionRemaining, coinsuranceRemaining,
        insuranceOption.employeePlan.coinsuranceRate);

      savingsContributionRemaining -= paymentShare.paidFromSavingsContribution;
      deductibleRemaining -= paymentShare.paidFromDeductible;
      coinsuranceRemaining -= paymentShare.paidFromCoinsurance;

      paymentShares.push(paymentShare);
    }
    return paymentShares;
  }

  function buildCustomChartOptions(scenario) {
    var chartTitle = scenario.insuranceOption.employeePlan.planName + ' - ' + scenario.insuranceOption.employeePlan.coverageLevel;
    var premium = scenario.insuranceOption.employeePlan.premium;
    var highChartOptionObject =
      {
        title: {
          text: chartTitle,
        },
        xAxis: {
          categories: ['Jan', 'Feb', 'Mar',
            'Apr', 'May', 'Jun',
            'Jul', 'Aug', 'Sep',
            'Oct', 'Nov', 'Dec'],
        },
        labels: {
          items: [{
            html: calculateTotalHealthcareSpending(scenario),
            style: {
              left: '50px',
              top: '18px',
              color: 'black',
            },
          }],
        },
        plotOptions: {
          column: {
            stacking: 'normal',
          },
        },
        series: [
          {
            type: 'column', // For some reason it is trying to make this first one a spline no matter what
            name: 'Premium',
            data: [],
          },
          {
            type: 'column',
            name: 'Insured Totally',
            data: arrayForProperty(scenario.performance, 'insuredTotally'),
          },
          {
            type: 'column',
            name: 'Insured By Coinsurance',
            data: arrayForProperty(scenario.performance, 'insuredByCoinsurance'),
          },
          {
            type: 'column',
            name: 'Paid From Coinsurance',
            data: arrayForProperty(scenario.performance, 'paidFromCoinsurance'),
          },
          {
            type: 'column',
            name: 'Paid From Deductible',
            data: arrayForProperty(scenario.performance, 'paidFromDeductible'),
          },
          {
            type: 'column',
            name: 'Paid From Savings Account Contribution',
            data: arrayForProperty(scenario.performance, 'paidFromSavingsContribution'),
          },
          // {
          //   type: 'spline',
          //   name: 'Average',
          //   data: [3, 2.67, 3, 6.33, 3.33],
          //   marker: {
          //       lineWidth: 2,
          //       fillColor: 'white'
          //     }
          // },
          {
            type: 'pie',
            name: 'Total spending',
            data: [
              {
                name: 'Premium',
                y: premium,
                color: Highcharts.getOptions().colors[0],
              },
              {
                name: 'Paid From Deductible',
                y: sumForProperty(scenario.performance, 'paidFromDeductible'),
                color: Highcharts.getOptions().colors[4],
              },
              {
                name: 'Paid From Coinsurance',
                y: sumForProperty(scenario.performance, 'paidFromCoinsurance'),
                color: Highcharts.getOptions().colors[3],
              },
            ],
            center: [100, 80],
            size: 100,
            showInLegend: false,
            dataLabels: {
              enabled: false,
            },
          },
        ],
      };
    return highChartOptionObject;
  }

  Polymer({
    is: 'my-scenarios',
    properties: {
      scenarios: {
        type: Array,
        notify: true,
        computed: 'calculateAll(insuranceOptions, healthcareCosts)',
      },
      logTotalHealthcareCosts: {
        type: Number,
        value: 8.16394095476,
      },
      totalHealthcareCosts: {
        type: Number,
        computed: 'exponent(logTotalHealthcareCosts)',
      },
      totalHealthcareCostsLabel: {
        type: Number,
        computed: 'generateHealthcareCostsLabel(totalHealthcareCosts)',
      },
      healthcareCosts: {
        type: Array,
        notify: true,
        // An array of 12 integers representing costs broken down by month
        computed: 'generateCostCurve(totalHealthcareCosts)',
      },
      chartOptions: {
        type: Array,
        notify: true,
        value: function () {
          var retVal = [];
          return retVal;
        },
      },
      insuranceOptions: {
        type: Array,
        notify: true,
      },
    },
    observers: [
      'buildChartOptions(scenarios)',
    ],
    exponent: function (value) {
      return Math.exp(value);
    },
    buildChartOptions: function (scenarios) {
      var i = 0;
      this.set('chartOptions', []);
      this.$.scenarioCharts.render();
      for (i = 0; i < scenarios.length; i += 1) {
        this.push('chartOptions', buildCustomChartOptions(scenarios[i]));
      }
    },
    calculateAll: function (insuranceOptions, healthcareCosts) {
      var i = 0;
      var scenario = {};
      var scenarios = [];
      // this.set('scenarios', []);

      for (i = 0; i < insuranceOptions.length; i += 1) {
        scenario = {};
        scenario.insuranceOption = insuranceOptions[i];
        scenario.performance = calculatePerformance(insuranceOptions[i], healthcareCosts);
        scenarios.push(scenario);
      }

      return scenarios;
    },
    generateHealthcareCostsLabel: function (totalHealthcareCosts) {
      var label = numeral(totalHealthcareCosts).format('$0,0');
      if (totalHealthcareCosts > 100000) {
        label = '$100,000 or more';
      }
      return label;
    },
    generateCostCurve: function (totalHealthcareCostsEmployee,
      totalHealthcareCostsSpouse, totalHealthcareCostsChildren) {
      var costCurve = [];
      var i = 1;
      var segments = 42;
      for (i = 1; i <= 6; i += 1) {
        costCurve.push({
          employee: totalHealthcareCostsEmployee * (i / segments),
          spouse: totalHealthcareCostsSpouse * (i / segments),
          children: totalHealthcareCostsChildren * (i / segments),
        });
      }

      for (i = 6; i >= 1; i -= 1) {
        costCurve.push({
          employee: totalHealthcareCostsEmployee * (i / segments),
          spouse: totalHealthcareCostsSpouse * (i / segments),
          children: totalHealthcareCostsChildren * (i / segments),
        });
      }

      return costCurve;
    },
  });

  </script>
</dom-module>
